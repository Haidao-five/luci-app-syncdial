#!/bin/sh
#PPPoE拨号在线接口数检测及重拨脚本
#Copyright (C) 2015 GuoGuo<gch981213@gmail.com>
. /lib/functions.sh

[ -f /etc/config/syncdial ] || {
	return 1
}

action_interface(){
	local action=$1
	local wan_action=$2
	local first_device=$3
	for device in $first_device
	do
		if [ "$device" = "$wan_action" ]; then
			[ "$old_frame" -eq 0 ] && {
				logger -t PPPoE-IFChecker "Interfaces: $wan_action; Action: $action"
				$action $wan_action
			}
		else
			logger -t PPPoE-IFChecker "Interfaces: $device; Action: $action"
			$action $device
		fi
	done
}

sync_redial(){
	local wan_select=$1
	local dialnum=$2
	p_ifname=`uci -q get network.$wan_select.ifname`
	ppp_num=`mwan3 interfaces | grep -v grep | grep -w "$wan_select" | grep -c "is online and tracking"`
	s_ifname=`uci show network| grep macvlandev_macvlan | grep "ifname='$p_ifname'"|awk -F'.' '{print $2}' |awk -F'_' '{print $2}'`
	first_device=$wan_select
	for ifname in $s_ifname
	do
		s_device=`uci show network| grep "ifname='$ifname" |awk -F'.' '{print $2}'`
		s_online_num=`mwan3 interfaces | grep -v grep | grep -w "$s_device" | grep -c "is online and tracking"`
		ppp_num=$(($ppp_num + $s_online_num))
		first_device="$first_device $s_device"
	done
	
	logger -t PPPoE-IFChecker "$ppp_num interfaces come from $wan_select are online."
	if [ "$ppp_num" -lt $dialnum ]; then
		logger -t PPPoE-IFChecker "Stop all interfaces created by $wan_select."
		action_interface ifdown $wan_select "$first_device"
		sleep $dialwait
		logger -t PPPoE-IFChecker "Start all interfaces created by $wan_select."
		action_interface ifup $wan_select "$first_device"
		logger -t PPPoE-IFChecker "Interfaces come from $wan_select have been restarted."
		logger -t PPPoE-IFChecker "Another checker will be started 60s later."
		sleep 60 && pppconnectcheck &
	else
		logger -t PPPoE-IFChecker "Nothing to do for the origin interface: $wan_select. Exit."
	fi
}

config_load "syncdial"
config_get_bool enabled config enabled 0
config_get_bool dialchk config dialchk 0
config_get_bool old_frame config old_frame
config_get dial config dialnum 0
config_get dial2 config dialnum2 0
config_get dialwait config dialwait 20
config_get wanselect config wanselect
config_get dial_type config dial_type
[ "$dial_type" -eq 2 ] && {
	config_get wanselect2 config wanselect2
}

[ "$enabled" = "0" ] && {
	echo "syncdial is disabled."
	logger -t PPPoE-IFChecker "Syncdial is not enabled. Exit pppconnectcheck."
	return 0
}

[ "$dialchk" = "0" ] && {
	echo "dial check disabled."
	return 0
}
if [ "$dial_type" -eq 2 ]; then
	[ $(ps | grep -v grep | grep -c "pppconnectcheck") -gt 4 ] && logger -t PPPoE-IFChecker "Another checker is running.exit." && return 1
else
	[ $(ps | grep -v grep | grep -c "pppconnectcheck") -gt 2 ] && logger -t PPPoE-IFChecker "Another checker is running.exit." && return 1
fi
sleep 10s
if [ "$dial_type" -eq 2 ]; then
	#二条线掉线检测
	sync_redial $wanselect $dial &
	sync_redial $wanselect2 $dial2
else
	#一条线掉线检测
	sync_redial $wanselect $dial
fi

return 0
